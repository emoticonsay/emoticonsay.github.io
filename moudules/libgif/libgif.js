(function(B,w){"function"===typeof define&&define.amd?define([],w):"object"===typeof exports?module.exports=w():B.SuperGif=w()})(this,function(){var B=function(c){return c.reduce(function(b,c){return 2*b+c},0)},w=function(c){for(var b=[],g=7;0<=g;g--)b.push(!!(c&1<<g));return b},J=function(c){this.data=c;this.len=this.data.length;this.pos=0;this.readByte=function(){if(this.pos>=this.data.length)throw Error("Attempted to read past end of stream.");return c instanceof Uint8Array?c[this.pos++]:c.charCodeAt(this.pos++)&
255};this.readBytes=function(b){for(var c=[],h=0;h<b;h++)c.push(this.readByte());return c};this.read=function(b){for(var c="",h=0;h<b;h++)c+=String.fromCharCode(this.readByte());return c};this.readUnsigned=function(){var b=this.readBytes(2);return(b[1]<<8)+b[0]}},F=function(c,b){for(var g=0,h=function(a){for(var c=0,m=0;m<a;m++)b.charCodeAt(g>>3)&1<<(g&7)&&(c|=1<<m),g++;return c},f=[],v=1<<c,a=v+1,d=c+1,e=[],A=function(){e=[];d=c+1;for(var b=0;b<v;b++)e[b]=[b];e[v]=[];e[a]=null},p,m;;)if(m=p,p=h(d),
p===v)A();else{if(p===a)break;if(p<e.length)m!==v&&e.push(e[m].concat(e[p][0]));else{if(p!==e.length)throw Error("Invalid LZW code.");e.push(e[m].concat(e[m][0]))}f.push.apply(f,e[p]);e.length===1<<d&&12>d&&d++}return f},S=function(c,b){b||(b={});var g=function(b){for(var d=[],e=0;e<b;e++)d.push(c.readBytes(3));return d},h=function(){var b,d;d="";do b=c.readByte(),d+=c.read(b);while(0!==b);return d},f=function(a){var d=function(a){c.readByte();var d=w(c.readByte());a.reserved=d.splice(0,3);a.disposalMethod=
B(d.splice(0,3));a.userInput=d.shift();a.transparencyGiven=d.shift();a.delayTime=c.readUnsigned();a.transparencyIndex=c.readByte();a.terminator=c.readByte();b.gce&&b.gce(a)},e=function(a){a.comment=h();b.com&&b.com(a)},f=function(a){c.readByte();a.ptHeader=c.readBytes(12);a.ptData=h();b.pte&&b.pte(a)},g=function(a){var d=function(a){c.readByte();a.unknown=c.readByte();a.iterations=c.readUnsigned();a.terminator=c.readByte();b.app&&b.app.NETSCAPE&&b.app.NETSCAPE(a)};c.readByte();a.identifier=c.read(8);
a.authCode=c.read(3);switch(a.identifier){case "NETSCAPE":d(a);break;default:(function(a){a.appData=h();b.app&&b.app[a.identifier]&&b.app[a.identifier](a)})(a)}};a.label=c.readByte();switch(a.label){case 249:a.extType="gce";d(a);break;case 254:a.extType="com";e(a);break;case 1:a.extType="pte";f(a);break;case 255:a.extType="app";g(a);break;default:a.extType="unknown",function(a){a.data=h();b.unknown&&b.unknown(a)}(a)}},v=function(){var a={};a.sentinel=c.readByte();switch(String.fromCharCode(a.sentinel)){case "!":a.type=
"ext";f(a);break;case ",":a.type="img";a.leftPos=c.readUnsigned();a.topPos=c.readUnsigned();a.width=c.readUnsigned();a.height=c.readUnsigned();var d=w(c.readByte());a.lctFlag=d.shift();a.interlaced=d.shift();a.sorted=d.shift();a.reserved=d.splice(0,2);a.lctSize=B(d.splice(0,3));a.lctFlag&&(a.lct=g(1<<a.lctSize+1));a.lzwMinCodeSize=c.readByte();d=h();a.pixels=F(a.lzwMinCodeSize,d);if(a.interlaced){for(var d=a.pixels,e=a.width,A=Array(d.length),p=d.length/e,m=[0,4,2,1],t=[8,8,4,2],x=0,z=0;4>z;z++)for(var u=
m[z];u<p;u+=t[z]){var r=u,C=d.slice(x*e,(x+1)*e);A.splice.apply(A,[r*e,e].concat(C));x++}a.pixels=A}b.img&&b.img(a);break;case ";":a.type="eof";b.eof&&b.eof(a);break;default:throw Error("Unknown block: 0x"+a.sentinel.toString(16));}"eof"!==a.type&&setTimeout(v,0)};(function(){var a={};a.sig=c.read(3);a.ver=c.read(3);if("GIF"!==a.sig)throw Error("Not a GIF file.");a.width=c.readUnsigned();a.height=c.readUnsigned();var d=w(c.readByte());a.gctFlag=d.shift();a.colorRes=B(d.splice(0,3));a.sorted=d.shift();
a.gctSize=B(d.splice(0,3));a.bgColor=c.readByte();a.pixelAspectRatio=c.readByte();a.gctFlag&&(a.gct=g(1<<a.gctSize+1));b.hdr&&b.hdr(a)})();setTimeout(v,0)};return function(c){var b={vp_l:0,vp_t:0,vp_w:null,vp_h:null,c_w:null,c_h:null},g;for(g in c)b[g]=c[g];b.vp_w&&b.vp_h&&(b.is_vp=!0);var h,f,v=null,a=!1,d=null,e=null,A=null,p=0,m=null,t=null,x=null,z=!0,u=!1,r=[],C=[],q=b.gif;"undefined"==typeof b.auto_play&&(b.auto_play=!q.getAttribute("rel:auto_play")||"1"==q.getAttribute("rel:auto_play"));var w=
b.hasOwnProperty("on_end")?b.on_end:null,B=b.hasOwnProperty("loop_delay")?b.loop_delay:0,F=b.hasOwnProperty("loop_mode")?b.loop_mode:"auto",K=b.hasOwnProperty("draw_while_loading")?b.draw_while_loading:!0,T=K?b.hasOwnProperty("show_progress_bar")?b.show_progress_bar:!0:!1,L=function(){e=d=null;m=A;t=A=null},N=function(){try{S(h,U)}catch(a){M("parse")}},O=function(a,b){n.width=a*k();n.height=b*k();E.style.minWidth=a*k()+"px";y.width=a;y.height=b;y.style.width=a+"px";y.style.height=b+"px";y.getContext("2d").setTransform(1,
0,0,1,0,0)},G=function(a,c,d){if(d&&T){d=25;var e,f;b.is_vp?u?(f=(b.vp_t+b.vp_h-d)/k(),d/=k(),e=b.vp_l/k(),a=e+a/c*(b.vp_w/k()),c=n.width/k()):(f=b.vp_t+b.vp_h-d,e=b.vp_l,a=e+a/c*b.vp_w,c=n.width):(f=(n.height-d)/(u?k():1),a=a/c*n.width/(u?k():1),c=n.width/(u?k():1),d/=u?k():1);l.fillStyle="rgba(255,255,255,0.4)";l.fillRect(a,f,c-a,d);l.fillStyle="rgba(255,0,22,.8)";l.fillRect(0,f,a,d)}},M=function(a){v=a;f={width:q.width,height:q.height};r=[];l.fillStyle="black";l.fillRect(0,0,b.c_w?b.c_w:f.width,
b.c_h?b.c_h:f.height);l.strokeStyle="red";l.lineWidth=3;l.moveTo(0,0);l.lineTo(b.c_w?b.c_w:f.width,b.c_h?b.c_h:f.height);l.moveTo(0,b.c_h?b.c_h:f.height);l.lineTo(b.c_w?b.c_w:f.width,0);l.stroke()},P=function(){t&&(r.push({data:t.getImageData(0,0,f.width,f.height),delay:e}),C.push({x:0,y:0}))},D=function(){var a=-1,c=0,d=function(b){a+=b;g()},e=function(){null!==w&&w(q);c++},f=function(){var b=!1,f=function(){if(b=z){d(1);var g=10*r[a].delay;g||(g=100);var h;h=(a+1+r.length)%r.length;0===h&&(g+=B,
setTimeout(e,g-1));(!1!==F||0!==h||0>c)&&setTimeout(f,g)}};return function(){b||setTimeout(f,0)}}(),g=function(){var b;a=parseInt(a,10);a>r.length-1&&(a=0);0>a&&(a=0);b=C[a];y.getContext("2d").putImageData(r[a].data,b.x,b.y);l.globalCompositeOperation="copy";l.drawImage(y,0,0)};return{init:function(){v||(b.c_w&&b.c_h||l.scale(k(),k()),b.auto_play?f():(a=0,g()))},step:f,play:function(){z=!0;f()},pause:function(){z=!1},playing:z,move_relative:d,current_frame:function(){return a},length:function(){return r.length},
move_to:function(b){a=b;g()}}}();c=function(){};g=function(a,b){return function(c){a(c);G(h.pos,h.data.length,b)}};var U={hdr:g(function(a){f=a;O(f.width,f.height)}),gce:g(function(a){P();L();d=a.transparencyGiven?a.transparencyIndex:null;e=a.delayTime;A=a.disposalMethod}),com:g(c),app:{NETSCAPE:g(c)},img:g(function(a){t||(t=y.getContext("2d"));var b=r.length,c=a.lctFlag?a.lct:f.gct;0<b&&(3===m?t.putImageData(r[p].data,0,0):p=b-1,2===m&&t.clearRect(x.leftPos,x.topPos,x.width,x.height));var b=t.getImageData(a.leftPos,
a.topPos,a.width,a.height),e=b.data;a.pixels.forEach(function(a,b){a!==d&&(e[4*b+0]=c[a][0],e[4*b+1]=c[a][1],e[4*b+2]=c[a][2],e[4*b+3]=255)});b.data.set(e);t.putImageData(b,a.leftPos,a.topPos);u||(l.scale(k(),k()),u=!0);K&&l.drawImage(y,0,0);x=a},!0),eof:function(c){P();G(h.pos,h.data.length,!1);b.c_w&&b.c_h||(n.width=f.width*k(),n.height=f.height*k());D.init();a=!1;H&&H(q)}},Q=function(){var a=q.parentNode,c=document.createElement("div");n=document.createElement("canvas");l=n.getContext("2d");E=
document.createElement("div");y=document.createElement("canvas");c.width=n.width=q.width;c.height=n.height=q.height;E.style.minWidth=q.width+"px";c.className="jsgif";E.className="jsgif_toolbar";c.appendChild(n);c.appendChild(E);a.insertBefore(c,q);a.removeChild(q);b.c_w&&b.c_h&&O(b.c_w,b.c_h);I=!0},k=function(){return b.max_width&&f&&f.width>b.max_width?b.max_width/f.width:1},n,l,E,y,I=!1,H=!1,R=function(b){if(a)return!1;H=b?b:!1;a=!0;r=[];L();p=0;x=t=m=null;return!0};return{play:D.play,pause:D.pause,
move_relative:D.move_relative,move_to:D.move_to,get_playing:function(){return D.playing},get_canvas:function(){return n},get_canvas_scale:function(){return k()},get_loading:function(){return a},get_auto_play:function(){return b.auto_play},get_length:function(){return D.length()},get_current_frame:function(){return D.current_frame()},load_url:function(a,b){if(R(b)){var c=new XMLHttpRequest;c.overrideMimeType("text/plain; charset=x-user-defined");c.onloadstart=function(){I||Q()};c.onload=function(a){h=
new J(c.responseText);setTimeout(N,0)};c.onprogress=function(a){a.lengthComputable&&G(a.loaded,a.total,!0)};c.onerror=function(){M("xhr")};c.open("GET",a,!0);c.send()}},load:function(a){this.load_url(q.getAttribute("rel:animated_src")||q.src,a)},load_raw:function(a,b){R(b)&&(I||Q(),h=new J(a),setTimeout(N,0))},set_frame_offset:function(a,b){C[a]?("undefined"!==typeof b.x&&(C[a].x=b.x),"undefined"!==typeof b.y&&(C[a].y=b.y)):C[a]=b}}}});