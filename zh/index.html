<!DOCTYPE html>
<html>
  <head>
    <title>表情说 - 在线图文合成</title>
    <meta charset="utf-8">
    <meta name="description" content="这是一款表情制作器。点一下鼠标就能在你的表情上添加文字，这是调戏朋友的好办法！">
    <meta name="keywords" content="图文合成 图片加文字 表情加文字 自制表情 表情 表情制作 在线 聊天 QQ 微信 whatsapp facebook">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="text/javascript" src="../moudules/jquery/jquery.min.js"></script>
    <script src="../moudules/bootstrap/bootstrap.min.js"></script>

    <link href="../moudules/bootstrap/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="../moudules/imgAreaSelect/css/imgareaselect-default.css" />

    <link rel="shortcut icon" href="../favicon.ico" />

    <!-- 语言，每种语言的页面都要有所有支持语言的声明 -->
    <link rel="alternate" hreflang="en" href="http://emoticonsay.com/" />
    <link rel="alternate" hreflang="zh" href="http://emoticonsay.com/zh" />
  </head>

  <body style="background-color:linear-gradient(white, #D3D8E8)">

    <div class="row navbar navbar-default"  style="height:82px;width:100%;background-color:rgba(60,163,83,1)">
      <div class="container" style="width:960px;">
        <div class="col-lg-12" style="text-align:center">
          <img src="logo.png" height="40px" style="display:inline;margin-top:25px;margin-left:20px"/>
        </div>
        
      </div>
    </div>

    <div class="container" style="width:960px;">

      <div class="row">

        <div class="col-md-12" >
          <center>
          <div class="panel panel-primary" style="width:600px;border-color:rgba(60,163,83,1)">
            <div class="panel-body">点一下鼠标，在你的表情上添加文字，这是调戏朋友的好办法！</div>
          </div>
          
          <div class="panel panel-primary" style="width:600px;margin-top:-10px;border-color:rgba(60,163,83,1)">
            <div class="panel-heading" style="font-weight:bold;font-size:10px;padding:5px 15px;background-color:rgba(60,163,83,1);border-color:rgba(60,163,83,1)">1. 上传表情图片</div>

            <div class="panel-body">
              <!--
              <div style="width:402px;min-height:252px;margin-top:0px">
              -->
                <div id="result_bg" style="width:402px;min-height:242px;background-color:#bfbfbf;">
                  <div id="result" style="max-width:402px;width:0px;border:1px solid rgba(60,163,83,1);background-color:white;position:relative">

                    <img id="pic_area" src="" alt="" style="max-width:400px;max-height:400px;background-color:white" data-adaptive-background="1" />

                    <div id="blabla" style="margin-left:5%;margin-right-5%;font-size:16px;font-weight:bold;text-align:center">

                    </div>
                    
                  </div>

                  <button id="selectPic" class="btn btn-primary" style="margin-top:100px;background-color:rgba(60,163,83,1);border-color:rgba(60,163,83,1);">上传</button>

                  

                  <form name="form1">
                    <input id="picFile" type="file" name="picFile"> 
                  </form>
                </div>
         <!--     
              </div>
            -->
              
<!--
              <button id="crop_btn" class="btn btn-xs btn-inverse" type="button" style="margin-top:5px">裁剪图片</button>
            -->
              <button id="upload_again" class="btn btn-xs btn-inverse" type="button" style="margin-top:5px">再次上传</button>
            </div>

          </div>

          <div class="panel panel-primary" style="width:600px;margin-top:-10px;border-color:rgba(60,163,83,1)">
            <div class="panel-heading" style="font-weight:bold;font-size:10px;padding:5px 15px;background-color:rgba(60,163,83,1);border-color:rgba(60,163,83,1)">2. 输入文字</div>
            
            <div class="panel-body">

              <!-- 富文本编辑器 -->
              <script id="container" name="content" type="text/plain" style="width:400px;height:60px;margin-top:0px">
              </script>
              
              <br/>

              <div class="row" style="width:400px">
                <div class="col-lg-6">
                  文字位置：
                  <select class="form-control" id="text_position">
                    <option>图片下方</option>
                    <option>图片上方</option>
                    <option>图片内部</option>
                  </select>
                </div>
                
                <div class="col-lg-6">
                文字背景色：
                <select class="form-control" id="text_background">
                  <option>自动</option>
                  <option>黑色</option>
                  <option>白色</option>
                </select>
                </div>
              </div>

              
              <button id="download" class="btn btn-primary" style="margin-top:20px;background-color:rgba(60,163,83,1);border-color:rgba(60,163,83,1);">下载</button>

            </div>
          </div>

          </center>
        </div>

<!--
        <div class="col-md-4" style="margin-left:-10px">

          <div class="panel panel-primary" style="width:300px;height:120px;border:1px solid rgba(60,163,83,1);margin-top:2px">
            
          </div>

          <div style="width:300px;height:250px;border:1px solid rgba(60,163,83,1);margin-top:-5px">
            <script type='text/javascript' src='//eclkmpbn.com/adServe/banners?tid=55440_85112_0'></script>
          </div>
          <div style="width:300px;height:250px;border:1px solid rgba(60,163,83,1);margin-top:15px">
            
          </div>
          
        </div>
        -->
      </div>
<!--
      <a href="http://redirect.simba.taobao.com/rd?w=unionnojs&f=http%3A%2F%2Fai.taobao.com%2Fauction%2Fedetail.htm%3Fe%3DPVt2B1qEBgTuDAZjWhpTWJQe4xnorIzd0nYVACa9TVBBWJVBnwmj7tnO073KpEUuesayvrQ7hvmI%252B6SsYddQHofkoXd6jYIV8k42%252Bp9%252F3ZBA8Ulzz4R1HSdmySXuxMkyHWMMKB0ZUHjJnH7RnLtLRQ%253D%253D%26ptype%3D100010%26from%3Dbasic&k=5ccfdb950740ca16&c=un&b=alimm_0&p=mm_32135518_10834412_36110859" target="_blank"><img src="ad1.png" width="200px" height="200px" /></a>
      
      <a href="http://redirect.simba.taobao.com/rd?w=unionnojs&f=http%3A%2F%2Fai.taobao.com%2Fauction%2Fedetail.htm%3Fe%3DsJz1nx0P6zi6k0Or%252B%252BH4tLArDoUQ6yn0WUgXPn%252FBwdSLltG5xFicOdXrTUTgh9sMDPIwxrc30riUoQH65Fgld5kzj4qAP8H2be6sV2rs9p6N9tCRMJonulRmtaud%252B0v%252BxcoA8IpTE8lvQm5Oc2e6tA%253D%253D%26ptype%3D100010%26from%3Dbasic&k=5ccfdb950740ca16&c=un&b=alimm_0&p=mm_32135518_10834412_36114640" target="_blank"><img src="ad2.png" width="200px" height="200px" /></a>
      
      <a href="http://redirect.simba.taobao.com/rd?w=unionnojs&f=http%3A%2F%2Fai.taobao.com%2Fauction%2Fedetail.htm%3Fe%3DpavmsjG%252Badu6k0Or%252B%252BH4tKBsKBKgmkKf5O1HRCRsNECLltG5xFicOdXrTUTgh9sMDPIwxrc30riUoQH65Fgld5kzj4qAP8H2be6sV2rs9p53QAJ7K5E%252FIFRmtaud%252B0v%252BxcoA8IpTE8mD2xI%252Bo8o2lw%253D%253D%26ptype%3D100010%26from%3Dbasic&k=5ccfdb950740ca16&c=un&b=alimm_0&p=mm_32135518_10834412_36126453" target="_blank"><img src="ad3.png" width="200px" height="200px" /></a>
    -->
    </div>



    <footer>
        <center>
        <br/>
        <div style="width:960px;height:-1px;border:1px solid rgba(60,163,83,1)"></div>
        <div id="homepage-copyinfo" style="margin-top:15px">&copy; 2015 EmoticonSay</div>
        <br/><br/>
      </center>
    <footer>

    <!-- 模态框（Modal） -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" 
       aria-labelledby="myModalLabel" aria-hidden="true">
       <div class="modal-dialog">
          <div class="modal-content">
             <div class="modal-header">
                <h4 class="modal-title" id="myModalLabel">
                   正在生成
                </h4>
             </div>
             <div class="modal-body">
                正在生成gif表情，这需要一点时间。
                <div class="progress">
                   <div id="gifProgress" class="progress-bar" role="progressbar" aria-valuenow="00" 
                      aria-valuemin="0" aria-valuemax="100" style="width: 0%;">

                   </div>
                </div>
             </div>
          </div>
    </div>

    <script type="text/javascript" src="../moudules/imgAreaSelect/scripts/jquery.imgareaselect.pack.js"></script>
    <script type="text/javascript" src="../moudules/adaptive-backgrounds/adaptive-backgrounds.js"></script>
    <script type="text/javascript" src="../moudules/ueditor/ueditor.config.js"></script>
    <script type="text/javascript" src="../moudules/ueditor/ueditor.all.js"></script>
    <script type="text/javascript" src="../moudules/html2canvas/html2canvas.js"></script>
    <script type="text/javascript" src="../moudules/libgif/libgif.js"></script>
    <script type="text/javascript" src="../moudules/libgif/rubbable.js"></script>
    <script type="text/javascript" src="../moudules/gif/gif.js"></script>
    <script type="text/javascript" src="../moudules/gif/gif.worker.js"></script>
    <script type="text/javascript" src="//static.addtoany.com/menu/page.js"></script>

    <script>AdaptiveBackgrounds()</script>

    <script>
      var currentImageType;
      $(document).ready(function(){
        //初始化ueditor
        var ue = UE.getEditor('container',{toolbars:[
          [
            'fontfamily', //字体
            'fontsize', //字号
            'forecolor', //字体颜色
            'justifyleft', //居左对齐
            'justifycenter', //居中对齐
            'justifyright' //居右对齐
          ]
        ]});
                
        //事件
        ue.addListener("contentChange",function(){
            console.log('内容改变:'+ue.getContent());
            $("#blabla").html(ue.getContent());
            $("#blabla>p").css("margin","3px");
            $("#result_bg").css("padding-top",(parseInt($("#result_bg").css("height").split("px")[0])-parseInt($("#result").css("height").split("px")[0]))/2);
        });

        //初始化AdaptiveBackgrounds
        AdaptiveBackgrounds();

        //默认的样式
        //$("#crop_btn").hide();//裁剪按钮
        $("#upload_again").hide();//重新上传

        //选择文件，隐藏原始文件表单项
        $("#picFile").hide();
        $("#selectPic").click(function(){
          document.form1.picFile.click();
        });
        $("#upload_again").click(function(){
          document.form1.picFile.click();
        });

        //选择文件后，回显图片
        $("input[type='file']").change(function(){
          function previewImage(file){
            if (file["files"] && file["files"][0]){ 
              currentImageType=file["files"][0].type;
              if(currentImageType==="image/jpeg" || currentImageType==="image/jpg" || currentImageType==="image/png" || currentImageType==="image/gif"){

                $("#pic_area").show();
                $(".jsgif").remove();

                //使用FileReader对象来读取本地数据,并将数据赋值给image的src  
                var reader = new FileReader();  
                reader.onload =function(evt){  
                  $('#pic_area')[0].onload=function(){
                    
                    //判断是否有透明像素，有则使背景色为透明，无则用background-adaptive
                    function HasTransparent(img)
                    {
                      var c = document.createElement('canvas');

                      var w = img.width, h = img.height;

                      c.width = w;
                      c.height = h;

                      var ctx = c.getContext('2d');

                      ctx.drawImage(img, 0, 0, w, h);
                      var imageData = ctx.getImageData(0,0, w, h);
                      var pixel = imageData.data;

                      var r=0, g=1, b=2,a=3;
                      for (var p = 0; p<pixel.length; p+=4)
                      {
                        if (pixel[p+a] == 0) // if white then change alpha to 0
                        {
                          return true;

                        }
                      }

                      return false;
                    }

                    var img=new Image();
                    img.src=evt.target.result;
                    
                    if(HasTransparent(img)){
                      console.log("有透明像素");
                      $("#result").css({"background-color":"white"});
                      //$("#result").css({"opacity":"0"});
                    }
                    else{
                      console.log("无透明像素");
                      AdaptiveBackgrounds();
                    }

                    $("#result").css("width", $('#pic_area')[0].width+2);

                    $("#selectPic").hide();
                    //$("#crop_btn").show();
                    $("#upload_again").show();

                    console.log("result_bg.height:"+$("#result_bg").innerHeight());
                    console.log("result.height:"+parseInt($("#result").css("height").split("px")[0]));
                    console.log("result_bg.padding-top:"+(parseInt($("#result_bg").css("height").split("px")[0])-parseInt($("#result").css("height").split("px")[0]))/2.0);

                    $("#result_bg").css("padding-top",(parseInt($("#result_bg").css("height").split("px")[0])-parseInt($("#result").css("height").split("px")[0]))/2.0);

                  };
                  
                  $('#pic_area').attr({src :evt.target.result});
                  
                  
                }  
                reader.readAsDataURL(file.files[0]);
              }
              else{
                alert("图片格式必须为jpg、png或gif。"+"目前类型是："+file["files"][0].type);
              }

              /* 
              var reader = new FileReader();  
              reader.onload =function(evt){  
                
                $('#pic_area').attr({src :evt.target.result}); 
                $("#result").css("width", $('#pic_area')[0].width);

                $('#pic_area').imgAreaSelect({
                    handles: true,
                    onSelectEnd: function (img, selection) {
                      var crop_canvas,  
                          left = selection.x1,  
                          top =  selection.y1,  
                          width = selection.width,  
                          height = selection.height;  
                             
                      crop_canvas = document.createElement('canvas');  
                      crop_canvas.width = width;  
                      crop_canvas.height = height;  
                         

                      //img如果是大图片(原图宽度大于400)会出错，需要resize
                      if(img.width>=400){
                        var resize_canvas=document.createElement('canvas');
                        resize_canvas.width = 400;  
                        resize_canvas.height = 400*img.height/img.width;  
                        resize_canvas.getContext('2d').drawImage(img, 0, 0, resize_canvas.width, resize_canvas.height);     
                        var resized_img = new Image();
                        resized_img.src = resize_canvas.toDataURL("image/png");
                        crop_canvas.getContext('2d').drawImage(resized_img, left, top, width, height, 0, 0, width, height); 
                      }
                      else{
                        crop_canvas.getContext('2d').drawImage(img, left, top, width, height, 0, 0, width, height); 
                      } 
                      window.open(crop_canvas.toDataURL("image/png"));  

                      //$('#pic_area2').attr({src:img.src});
                      //alert('width: ' + selection.width + '; height: ' + selection.height);
                    }
                });


              }  
              reader.readAsDataURL(file.files[0]); 
              */
            }
          }

          previewImage(this);
        });

        $("#text_position").change(function(){
          if($(this).get(0).selectedIndex==0){//bottom
            $("#pic_area").after($("#blabla")); 
            $("#blabla").css("position","static");
          }
          else if($(this).get(0).selectedIndex==1){//top
            $("#blabla").after($("#pic_area")); 
            $("#blabla").css("position","static");
          }
          else if($(this).get(0).selectedIndex==2){//inside
            $("#blabla").css("position","absolute");
            $("#blabla").css("left","0px");
            $("#blabla").css("top","0px");
            $("#blabla").css("width",$("#result").css("width"));
          }
        });

        $("#text_background").change(function(){
          if($(this).get(0).selectedIndex==0){
            AdaptiveBackgrounds();
          }
          else if($(this).get(0).selectedIndex==1){
            $("#result").css("background-color","black");
          }
          else if($(this).get(0).selectedIndex==2){
            $("#result").css("background-color","white");
          }
        });
        
        $("#download").click(function(){

          $("#result").css("border","");
          if(currentImageType==="image/gif"){  
            $("#myModal").modal('show');
            $("#gifProgress").css("width","0%");

            //获得每两帧间隔时间（gify）

            //以SuperGif控件显示在预览区
            var gifEelementHtml="<img id=\"gif_pic_area\" src=\"\" rel:auto_play=\"0\" rel:rubbable=\"0\" alt=\"\" style=\"max-width:400px;\" data-adaptive-background=\"1\">";
            $(gifEelementHtml).insertAfter("#pic_area");
            $('#gif_pic_area').attr({"src":""}); 
            $('#gif_pic_area').attr({"rel:animated_src":$('#pic_area')[0].src});
            $('#pic_area').hide();
            var rub = new SuperGif({ gif: $('#gif_pic_area')[0] } );
            rub.load(function(){
              console.log("gif length:"+rub.get_length());
              var rub_length=rub.get_length();

              var progressNow=0;

              var gif = new GIF({
                workers: 1,
                quality: 10
              });

              function recordFrame(from,to,callback){
                rub.move_to(from);

                setTimeout(function(){
                    html2canvas($("#result")[0],{background: "#fff"}).then(function(canvas) {
                      //document.body.appendChild(canvas);
                      gif.addFrame(canvas, {delay: 1000/10,copy:true});

                      progressNow+=1;
                      console.log("AAA"+progressNow/(rub_length*2));
                      $("#gifProgress").css("width",progressNow/rub_length*100+"%");
                    });

                    if(from<to)recordFrame(from+1,to,callback);
                    else callback();

                }, 300);
              }

              recordFrame(0,rub_length,function(){
                //生成新的gif
                gif.on('finished', function(blob) {
                  $("#myModal").modal('hide');

                  rub.play();

                  console.log("gif finished");
                  $("#result").css("border","1px solid rgba(60,163,83,1)");

                  //下载
                  var aLink = document.createElement('a');
                  var evt = document.createEvent("HTMLEvents");
                  evt.initEvent("click", false, false);
                  aLink.download = "EmoticonSay"+".gif";
                  aLink.href = URL.createObjectURL(blob);
                  aLink.dispatchEvent(evt);
                });

                gif.render();
              });
              

              //显示新的gif

            });

            return;
          }

          //如果是jpg png jpeg
          html2canvas($("#result")[0],{background: "#fff"}).then(function(canvas) {
              $("#result").css("border","1px solid rgba(60,163,83,1)");

              var aLink = document.createElement('a');
              var evt = document.createEvent("HTMLEvents");
              evt.initEvent("click", false, false);
              aLink.download = "EmoticonSay."+currentImageType.split("/")[1];
              aLink.href = canvas.toDataURL(currentImageType);
              aLink.dispatchEvent(evt);
          });
        });
        
      });

    </script>
    
    <!-- google analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-66602537-1', 'auto');
      ga('send', 'pageview');

    </script>

  </body>
</html>